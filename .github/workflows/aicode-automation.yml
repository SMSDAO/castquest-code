name: AiCode Complete Automation

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      mode:
        description: 'Orchestration mode'
        required: true
        default: 'ci'
        type: choice
        options:
          - full
          - development
          - ci
          - deployment

jobs:
  aicode-automation:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'app/package-lock.json'

      - name: ðŸ“¦ Install dependencies
        run: |
          cd app
          npm ci

      - name: ðŸ” Run AiCode Analysis
        run: |
          cd app
          npm run aicode:analyze
        continue-on-error: true

      - name: ðŸ”§ Auto Config
        run: |
          cd app
          npm run config
        continue-on-error: true

      - name: ðŸ©¹ Auto Repair
        run: |
          cd app
          npm run repair
        continue-on-error: true

      - name: ðŸ”§ Auto Fix
        run: |
          cd app
          npm run fix -- --categories security,logic
        continue-on-error: true

      - name: ðŸ§ª Auto Test with Coverage
        run: |
          cd app
          npm run auto-test -- --coverage
        continue-on-error: true

      - name: ðŸ“ Auto Comments
        run: |
          cd app
          npm run comments
        continue-on-error: true

      - name: ðŸ“Š Upload Coverage
        if: always()
        uses: codecov/codecov-action@v3
        with:
          directory: ./app/coverage
        continue-on-error: true

      - name: ðŸš€ Run Full Orchestration
        run: |
          cd app
          npx ts-node orchestrator.ts ci .
        env:
          NODE_ENV: production

      - name: ðŸ“‹ Generate Report
        if: always()
        run: |
          echo "## AiCode Automation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Automation completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Phases Executed:" >> $GITHUB_STEP_SUMMARY
          echo "- Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- Auto Config" >> $GITHUB_STEP_SUMMARY
          echo "- Auto Repair" >> $GITHUB_STEP_SUMMARY
          echo "- Auto Fix" >> $GITHUB_STEP_SUMMARY
          echo "- Auto Test" >> $GITHUB_STEP_SUMMARY
          echo "- Auto Comments" >> $GITHUB_STEP_SUMMARY

  deploy:
    needs: aicode-automation
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: ðŸ“¦ Install dependencies
        run: |
          cd app
          npm ci

      - name: ðŸš€ Deploy to Vercel
        run: |
          cd app
          npm run deploy
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        continue-on-error: true

      - name: ðŸ“‹ Deployment Summary
        if: always()
        run: |
          echo "## Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ Deployment process completed" >> $GITHUB_STEP_SUMMARY
